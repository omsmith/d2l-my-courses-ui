<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-siren-parser/d2l-siren-parser.html">
<link rel="import" href="d2l-utility-behavior.html">

<script>
	'use strict';

	(function() {
		window.D2L = window.D2L || {};
		window.D2L.MyCourses = window.D2L.MyCourses || {};

		/*
		* Behavior that allows for course management
		*
		* "Management" in this case means having a pinned and unpinned list, and supporting switching an enrollment between the
		* two.
		*
		* @polymerBehavior window.D2L.MyCourses.CourseManagementBehavior
		*/
		window.D2L.MyCourses.CourseManagementBehaviorImpl = {
			properties: {
				// Set of pinned enrollment Entities
				pinnedEnrollments: {
					type: Array,
					value: function() {
						return [];
					},
					notify: true
				},
				// Set of unpinned enrollment Entities
				unpinnedEnrollments: {
					type: Array,
					value: function() {
						return [];
					},
					notify: true
				},
				// Set of enrollments Entities that are being transferred from unpinned to pinned state
				// Only used by `d2l-all-courses`
				pinnedEnrollmentsQueue: {
					type: Array,
					value: function() {
						return [];
					},
					notify: true
				},
				// Set of enrollments that are being transferred from pinned to unpinned state
				// Only used by `d2l-all-courses`
				unpinnedEnrollmentsQueue: {
					type: Array,
					value: function() {
						return [];
					},
					notify: true
				},
				// If enabled, the component will use the pinned/unpinned enrollment queues
				// In the case of `d2l-all-courses`, the enrollments are switching lists, so this is required.
				usePendingLists: {
					type: Boolean,
					value: false
				},
				// True when there are pinned enrollments (i.e. `pinnedEnrollments.length > 0`)
				_hasPinnedEnrollments: {
					type: Boolean,
					value: false
				},
				// True when there are any enrollments (pinned or unpinned)
				_hasEnrollments: {
					type: Boolean,
					value: false
				}
			},
			_enrollmentIdMap: {},
			listeners: {
				'tile-remove-complete': '_onTileRemoveComplete'
			},
			observers: [
				'_enrollmentsChanged(pinnedEnrollments.length, pinnedEnrollmentsQueue.length, unpinnedEnrollments.length, unpinnedEnrollmentsQueue.length)'
			],
			created: function() {
				this._tilesInPinStateTransition = [];
			},
			_enrollmentsChanged: function() {
				this.set('_hasPinnedEnrollments',
					this.pinnedEnrollments.length > 0 ||
					this.pinnedEnrollmentsQueue.length > 0);
				// Need to factor in queues here - if user has 1 enrollment, it will briefly
				// disappear from both enrollments arrays when pinned/unpinned
				this.set('_hasEnrollments',
					this._hasPinnedEnrollments ||
					this.unpinnedEnrollments.length > 0 ||
					this.unpinnedEnrollmentsQueue.length > 0);
			},
			_moveEnrollmentToPinnedList: function(enrollment) {
				// Remove enrollment from unpinned list, add to pinned
				var enrollmentId = this.getEntityIdentifier(enrollment);

				this._moveEnrollmentIdToPinnedList(enrollmentId);
			},
			_moveEnrollmentToUnpinnedList: function(enrollment) {
				// Remove enrollment from pinned list, add to unpinned
				var enrollmentId = this.getEntityIdentifier(enrollment);

				this._moveEnrollmentIdToUnpinnedList(enrollmentId);
			},
			_moveEnrollmentIdToPinnedList: function(enrollmentId) {
				for (var index = 0; index < this.unpinnedEnrollments.length; index++) {
					var pinnedEnrollmentId = this.getEntityIdentifier(this.unpinnedEnrollments[index]);
					if (pinnedEnrollmentId === enrollmentId) {
						var foundEnrollment = this.unpinnedEnrollments[index];
						this._setEnrollmentPinData(foundEnrollment, true);

						// If enabled, add to list of "to be added" pinned entities, and let consumer move to pinned list when desired
						if (this.usePendingLists) {
							this.push('pinnedEnrollmentsQueue', foundEnrollment);
						} else {
							this._tilesInPinStateTransition.push(enrollmentId);
							this.unshift('pinnedEnrollments', foundEnrollment);
						}

						this.splice('unpinnedEnrollments', index, 1);
						break;
					}
				}
			},
			_moveEnrollmentIdToUnpinnedList: function(enrollmentId) {
				for (var index = 0; index < this.pinnedEnrollments.length; index++) {
					var unpinnedEnrollmentId = this.getEntityIdentifier(this.pinnedEnrollments[index]);
					if (unpinnedEnrollmentId === enrollmentId) {
						var foundEnrollment = this.pinnedEnrollments[index];
						this._setEnrollmentPinData(foundEnrollment, false);

						// If enabled, add to list of "to be added" unpinned entities, and let consumer move to unpinned list when desired
						if (this.usePendingLists) {
							this.push('unpinnedEnrollmentsQueue', foundEnrollment);
						} else {
							this._tilesInPinStateTransition.push(enrollmentId);
							this.unshift('unpinnedEnrollments', foundEnrollment);
						}

						this.splice('pinnedEnrollments', index, 1);
						break;
					}
				}
			},
			_onTileRemoveComplete: function(e) {
				if (e.detail.pinned) {
					this._moveEnrollmentToPinnedList(e.detail.enrollment);
				} else {
					this._moveEnrollmentToUnpinnedList(e.detail.enrollment);
				}
			},
			_setEnrollmentPinData: function(entity, isPinned) {
				// HACK: Because the course tiles are being removed and re-created in the DOM, we have to effectively
				// manually update them, rather than updating them with the received enrollment from the API call.
				if (isPinned) {
					entity.class.splice(entity.class.indexOf('unpinned'));
					entity.class.push('pinned');
					entity.actions[0].name = 'unpin-course';
					entity.actions[0].fields[0].value = false;
					entity._actionsByName['unpin-course'] = entity.actions[0];
				} else {
					entity.class.splice(entity.class.indexOf('pinned'));
					entity.class.push('unpinned');
					entity.actions[0].name = 'pin-course';
					entity.actions[0].fields[0].value = true;
					entity._actionsByName['pin-course'] = entity.actions[0];
				}
			},
			_pinEnrollment: function(orgUnitId) {
				this._moveEnrollmentIdToPinnedList(this._enrollmentIdMap[orgUnitId]);
			},
			_unpinEnrollment: function(orgUnitId) {
				this._moveEnrollmentIdToUnpinnedList(this._enrollmentIdMap[orgUnitId]);
			}
		};

		window.D2L.MyCourses.CourseManagementBehavior = [
			window.D2L.MyCourses.CourseManagementBehaviorImpl,
			window.D2L.MyCourses.UtilityBehavior
		];
	})();
</script>
