<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../d2l-ajax/d2l-ajax.html">
<link rel="import" href="../d2l-siren-parser/d2l-siren-parser.html">
<link rel="import" href="../d2l-link/d2l-link.html">
<link rel="import" href="../d2l-loading-spinner/d2l-loading-spinner.html">
<link rel="import" href="d2l-alert.html">
<link rel="import" href="d2l-simple-overlay.html">
<link rel="import" href="d2l-all-courses.html">
<link rel="import" href="d2l-course-tile-grid.html">
<link rel="import" href="localize-behavior.html">
<link rel="import" href="d2l-course-management-behavior.html">
<link rel="import" href="./image-selector/d2l-basic-image-selector.html">

<!--
`<d2l-my-courses>` is the main component for My Courses widget

@demo demo/d2l-my-courses-demo.html
-->
<dom-module id="d2l-my-courses">
	<template>
		<style include="d2l-colors"></style>
		<style include="d2l-typography-shared-styles"></style>
		<style>
			:host {
				display: block;
			}
			@media not all and (hover: hover) {
				:host {
					-webkit-user-select: none;
					user-select: none;
				}
			}
			.all-courses-button {
				@apply(--d2l-small-text);
				/* overrides to d2l-small-text */
				color: var(--d2l-color-celestine);
				margin: 1rem 0px 0px 0px;
				font-weight: 700;
				/* end overrides */
				display: block;
				background: none;
				border: none;
				padding: 0;
				cursor: pointer;
				position: relative;
			}
			.all-courses-button:hover {
				text-decoration: underline;
			}
			.hidden {
				display: none;
			}
			d2l-alert {
				padding-bottom: 30px;
				clear: both;
			}
			d2l-loading-spinner {
				display: block;
				margin: auto;
			}

			#lazyLoadSpinner {
				margin-bottom: 30px;
			}

			#basic-image-selector-overlay {
				--simple-overlay-content-width: {
					padding: 0;
				}
			}
		</style>

		<d2l-ajax
			id="enrollmentsRootRequest"
			url="[[enrollmentsUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-iron-ajax-response="_onEnrollmentsRootResponse">
		</d2l-ajax>

		<d2l-ajax
			id="enrollmentsSearchRequest"
			url="[[_enrollmentsSearchUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-iron-ajax-response="_onEnrollmentsSearchResponse"
			last-response="{{_lastEnrollmentsSearchResponse}}">
		</d2l-ajax>

		<d2l-loading-spinner
			id="initialLoadingSpinner"
			class="hidden"
			size="100">
		</d2l-loading-spinner>

		<div class="my-courses-content hidden">
			<d2l-alert visible="[[!_hasPinnedEnrollments]]">
				{{_alertMessage}}
				<a
					is="d2l-link"
					href="Javascript:void(0);"
					hidden$="[[_hasEnrollments]]"
					on-tap="_refreshPage">{{localize('refresh')}}</a>
			</d2l-alert>
			<d2l-course-tile-grid
				enrollments="{{pinnedEnrollments}}">
			</d2l-course-tile-grid>
			<button
				class="all-courses-button"
				hidden$="{{!_hasEnrollments}}"
				on-tap="_openAllCoursesView">
				{{localize('viewAllCourses')}}
			</button>
		</div>

		<d2l-simple-overlay
			id="all-courses"
			title$="{{localize('allCourses')}}"
			locale="[[locale]]"
			with-backdrop>

			<iron-scroll-threshold
				on-lower-threshold="_loadNextEnrollmentsPage">
			</iron-scroll-threshold>

			<d2l-all-courses
				pinned-enrollments="{{pinnedEnrollments}}"
				unpinned-enrollments="{{unpinnedEnrollments}}"
				locale="[[locale]]">
			</d2l-all-courses>
			<d2l-loading-spinner
				id="lazyLoadSpinner"
				class="hidden"
				size="100">
			</d2l-loading-spinner>
		</d2l-simple-overlay>

		<d2l-simple-overlay
			id="basic-image-selector-overlay"
			title$="{{localize('changeImage')}}"
			locale="[[locale]]"
			with-backdrop>

			<d2l-basic-image-selector locale="[[locale]]"></d2l-basic-image-selector>
		</d2l-simple-overlay>

	</template>

	<script>
		'use strict';

		Polymer({
			is: 'd2l-my-courses',

			/*
			* Fired when enrollments are received, to trigger recalculation of the number of columns
			* @event recalculate-columns
			*/

			properties: {
				/*
				* Allows for delaying the call to `enrollmentsUrl` (required by tests)
				* TODO: Better way to do this?
				* @type {Boolean}
				*/
				delayLoad: {
					type: Boolean,
					value: false
				},
				/*
				* URL that is called by the widget to fetch enrollments
				* @type {String}
				*/
				enrollmentsUrl: String,
				/*
				* Message to display in alert if no enrollments are found
				* @type {String}
				*/
				_alertMessage: String,
				/*
				* URL constructed to fetch a user's enrollments with the enrollments search Action
				* @type {String}
				*/
				_enrollmentsSearchUrl: String,
				/*
				* Object containing the last response from an enrollments search request
				* @type Object
				*/
				_lastEnrollmentsSearchResponse: Object,
				/*
				* Object containing the IDs of previously loaded pinned enrollments, to avoid duplicates
				* @type Object
				*/
				_pinnedCoursesMap: Object
			},
			behaviors: [
				Polymer.D2L.MyCourses.CourseTileResponsiveGridBehavior,
				Polymer.D2L.MyCourses.LocalizeBehavior,
				Polymer.D2L.MyCourses.InteractionDetectionBehavior,
				Polymer.D2L.MyCourses.CourseManagementBehavior
			],
			listeners: {
				'open-change-image-view': '_openChangeImageView'
			},
			ready: function() {
				this._pinnedCoursesMap = {};
				this._alertMessage = this.localize('noCoursesMessage');

				this.toggleClass('hidden', true, this.$.courseTiles);
				this.toggleClass('hidden', true, this.$.courseList);

				var allCoursesOverlay = this.$$('#all-courses');
				var allCourses = this.$$('d2l-all-courses');
				allCoursesOverlay.focusableNodesOverride = allCourses.focusableNodesOverride.bind(allCourses);
			},
			attached: function() {
				if (!this.delayLoad) {
					this.$.enrollmentsRootRequest.generateRequest();
				}

				this.$$('iron-scroll-threshold').scrollTarget = this.$['all-courses'].scrollRegion;
			},
			/*
			* Count of `d2l-course-tile` elements in grid.
			* @return {Number}
			*/
			getCourseTileItemCount: function() {
				return this.pinnedEnrollments.length;
			},
			_onEnrollmentsRootResponse: function(response) {
				if (response.detail.status === 200) {
					var parser = document.createElement('d2l-siren-parser');
					var enrollmentsRoot = parser.parse(response.detail.xhr.response);

					if (!enrollmentsRoot.hasAction('search-my-enrollments')) {
						return;
					}

					var searchAction = enrollmentsRoot.getActionByName('search-my-enrollments');

					var pinDateQuery = {
						pageSize: 25,
						embedDepth: 1,
						sortField: 'pinDate',
						sortDescending: true
					};
					this._enrollmentsSearchUrl = this.createActionUrl(searchAction, pinDateQuery);
					this.$.enrollmentsSearchRequest.generateRequest();
				} else {
					this._showContent();
				}
			},
			_onEnrollmentsSearchResponse: function(response) {
				if (response.detail.status === 200) {
					var parser = document.createElement('d2l-siren-parser');
					var enrollments = parser.parse(response.detail.xhr.response);
					var enrollmentEntities = enrollments.getSubEntitiesByClass('enrollment');
					var newPinnedEnrollments = [];
					var newUnpinnedEnrollments = [];

					enrollmentEntities.forEach(function(enrollment) {
						if (enrollment.hasClass('pinned')) {
							var enrollmentId = this.getEnrollmentIdentifier(enrollment);
							if (!this._pinnedCoursesMap.hasOwnProperty(enrollmentId)) {
								newPinnedEnrollments.push(enrollment);
								this._pinnedCoursesMap[enrollmentId] = true;
							}
						} else {
							newUnpinnedEnrollments.push(enrollment);
						}
					}, this);

					this.pinnedEnrollments = this.pinnedEnrollments.concat(newPinnedEnrollments);
					this.unpinnedEnrollments = this.unpinnedEnrollments.concat(newUnpinnedEnrollments);

					this.notifySplices('pinnedEnrollments', [{
						index: this.pinnedEnrollments.length - newPinnedEnrollments.length,
						removed: [],
						addedCount: newPinnedEnrollments.length,
						object: this.pinnedEnrollments,
						type: 'splice'
					}]);

					this.notifySplices('unpinnedEnrollments', [{
						index: this.unpinnedEnrollments.length - newUnpinnedEnrollments.length,
						removed: [],
						addedCount: newUnpinnedEnrollments.length,
						object: this.unpinnedEnrollments,
						type: 'splice'
					}]);

					this.set('enrollments', enrollmentEntities);

					this._hasPinnedEnrollments = this.pinnedEnrollments.length > 0;
					this._hasEnrollments = this._hasPinnedEnrollments || this.unpinnedEnrollments.length > 0;

					if (this._hasEnrollments) {
						this._alertMessage = this.localize('noPinnedCoursesMessage');
					}

					this.fire('recalculate-columns');
				}

				this.toggleClass('hidden', true, this.$.lazyLoadSpinner);
				this.$$('iron-scroll-threshold').clearTriggers();
				this._showContent();
			},
			_openChangeImageView: function() {
				var changeImageOverlay = this.$$('#basic-image-selector-overlay');
				var basicImageSelector = this.$$('d2l-basic-image-selector');
				changeImageOverlay.focusableNodesOverride = basicImageSelector.focusableNodesOverride.bind(basicImageSelector);

				this.$$('#basic-image-selector-overlay').open();
			},
			_openAllCoursesView: function(e) {
				e.preventDefault();
				e.stopPropagation();
				this.$$('#all-courses').open();
				this.$$('d2l-all-courses').loadCourseTiles();

				setTimeout(function() {
					// Slight delay to allow for overlay to get a DOM width before triggering the recalculation
					this.fire('recalculate-columns');
				}.bind(this), 50);
			},
			_refreshPage: function() {
				document.location.reload(true);
			},
			_showContent: function() {
				this.toggleClass('hidden', true, this.$.initialLoadingSpinner);
				this.toggleClass('hidden', false, this.$$('.my-courses-content'));
			},
			_loadNextEnrollmentsPage: function() {
				if (this.$['all-courses'].opened && this._lastEnrollmentsSearchResponse) {
					var parser = document.createElement('d2l-siren-parser');
					var lastResponseEntity = parser.parse(this._lastEnrollmentsSearchResponse);

					if (lastResponseEntity.hasLink('next')) {
						this._enrollmentsSearchUrl = lastResponseEntity.getLinkByRel('next').href;
						this.$.enrollmentsSearchRequest.generateRequest();
						this.toggleClass('hidden', false, this.$.lazyLoadSpinner);
					}
				}
			}
		});
	</script>
</dom-module>
