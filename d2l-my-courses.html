<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../d2l-ajax/d2l-ajax.html">
<link rel="import" href="../d2l-siren-parser/d2l-siren-parser.html">
<link rel="import" href="../d2l-link/d2l-link.html">
<link rel="import" href="../d2l-loading-spinner/d2l-loading-spinner.html">
<link rel="import" href="d2l-alert.html">
<link rel="import" href="d2l-alert-behavior.html">
<link rel="import" href="d2l-simple-overlay.html">
<link rel="import" href="d2l-all-courses.html">
<link rel="import" href="d2l-course-tile-grid.html">
<link rel="import" href="localize-behavior.html">
<link rel="import" href="d2l-course-management-behavior.html">
<link rel="import" href="./image-selector/d2l-basic-image-selector.html">

<dom-module id="d2l-my-courses">
	<template>
		<style include="d2l-typography-shared-styles">
			:host {
				display: block;
			}
			@media not all and (hover: hover) {
				:host {
					-webkit-user-select: none;
					user-select: none;
				}
			}
			.all-courses-button {
				@apply(--d2l-body-small-text);
				/* overrides to d2l-body-small-text */
				color: var(--d2l-color-celestine);
				margin: 1rem 0px 0px 0px;
				font-weight: 700;
				/* end overrides */
				display: block;
				background: none;
				border: none;
				padding: 0;
				cursor: pointer;
				position: relative;
			}
			.my-courses-content {
				padding-top: 10px;
			}
			.all-courses-button:hover, .all-courses-button:focus {
				text-decoration: underline;
			}
			.d2l-my-courses-hidden {
				display: none;
			}
			d2l-alert {
				display: block;
				margin-bottom: 20px;
				clear: both;
			}
			d2l-loading-spinner {
				display: block;
				margin: auto;
			}

			#lazyLoadSpinner {
				margin-bottom: 30px;
			}
		</style>

		<d2l-ajax
			id="enrollmentsRootRequest"
			url="[[enrollmentsUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-iron-ajax-response="_onEnrollmentsRootResponse">
		</d2l-ajax>

		<d2l-ajax
			id="enrollmentsSearchRequest"
			url="[[_enrollmentsSearchUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-iron-ajax-response="_onEnrollmentsSearchResponse"
			last-response="{{_lastEnrollmentsSearchResponse}}">
		</d2l-ajax>

		<d2l-loading-spinner
			id="initialLoadingSpinner"
			class="d2l-my-courses-hidden"
			size="100">
		</d2l-loading-spinner>

		<div class="my-courses-content d2l-my-courses-hidden">
			<template is="dom-repeat" items="{{_alerts}}">
				<d2l-alert type="[[item.alertType]]">
					{{item.alertMessage}}
					<a
						is="d2l-link"
						href="Javascript:void(0);"
						hidden$="[[_hasEnrollments]]"
						on-tap="_refreshPage">{{localize('refresh')}}</a>
				</d2l-alert>
			</template>
			<d2l-course-tile-grid
				enrollments="{{pinnedEnrollments}}"
				tile-sizes="[[_tileSizes]]"
				user-id="[[userId]]"
				tenant-id="[[tenantId]]"
				telemetry-endpoint="[[telemetryEndpoint]]"
				show-course-code="[[showCourseCode]]">
			</d2l-course-tile-grid>
			<button
				class="all-courses-button"
				hidden$="{{!_hasEnrollments}}"
				on-tap="_openAllCoursesView">
				{{localize('viewAllCourses')}}
			</button>
		</div>

		<d2l-simple-overlay
			id="all-courses"
			title-name="{{localize('allCourses')}}"
			locale="[[locale]]"
			with-backdrop>

			<iron-scroll-threshold
				id="all-courses-scroll-threshold"
				on-lower-threshold="_loadNextEnrollmentsPage">
			</iron-scroll-threshold>

			<d2l-all-courses
				pinned-enrollments="{{pinnedEnrollments}}"
				unpinned-enrollments="{{unpinnedEnrollments}}"
				my-enrollments-entity="[[_lastEnrollmentsSearchResponse]]"
				locale="[[locale]]"
				show-course-code="[[showCourseCode]]">
			</d2l-all-courses>
			<d2l-loading-spinner
				id="lazyLoadSpinner"
				class="d2l-my-courses-hidden"
				size="100">
			</d2l-loading-spinner>
		</d2l-simple-overlay>

		<d2l-simple-overlay
			id="basic-image-selector-overlay"
			title-name="{{localize('changeImage')}}"
			locale="[[locale]]"
			with-backdrop>
			<iron-scroll-threshold
				id="image-selector-threshold"
				on-lower-threshold="_changeImageLoadMore">
			</iron-scroll-threshold>
			<d2l-basic-image-selector
				image-catalog-location="[[imageCatalogLocation]]"
				organization="[[_setImageOrg]]"
				user-id="[[userId]]"
				tenant-id="[[tenantId]]"
				telemetry-endpoint="[[telemetryEndpoint]]"
			></d2l-basic-image-selector>
		</d2l-simple-overlay>

	</template>

	<script>
		'use strict';

		Polymer({
			is: 'd2l-my-courses',

			properties: {
				// URL that is called by the widget to fetch enrollments
				enrollmentsUrl: String,
				// URL that is called by the widget to fetch results from the course image catalog
				imageCatalogLocation: String,
				// hashed userid to send to telemetry
				userId: String,
				// hashed tenantid to send to telemetry
				tenantId: String,
				// URL to send telemetry to
				telemetryEndpoint: String,
				// URL constructed to fetch a user's enrollments with the enrollments search Action
				_enrollmentsSearchUrl: String,
				// Object containing the last response from an enrollments search request
				_lastEnrollmentsSearchResponse: Object,
				// Object containing the IDs of previously loaded pinned enrollments, to avoid duplicates
				_pinnedCoursesMap: Object,
				// URL used by the search widget to fetch semester-type organizations
				_semestersUrl: String,
				// The organization which the user is selecting the image of
				_setImageOrg: Object,
				// URL used by the search widget to fetch department-type organizations
				_departmentsUrl: String,
				// Size the tile should render with respect to vw
				_tileSizes: Object
			},
			behaviors: [
				window.D2L.MyCourses.CourseTileResponsiveGridBehavior,
				window.D2L.MyCourses.LocalizeBehavior,
				window.D2L.MyCourses.InteractionDetectionBehavior,
				window.D2L.MyCourses.CourseManagementBehavior,
				window.D2L.MyCourses.AlertBehavior
			],
			listeners: {
				'open-change-image-view': '_openChangeImageView',
				'set-course-image': '_setCourseImageEvent',
				'clear-image-scroll-threshold': '_clearImageScrollThreshold',
				'simple-overlay-closed': '_onSimpleOverlayClosed',
				'enrollment-pinned': '_onEnrollmentPinAction',
				'enrollment-unpinned': '_onEnrollmentPinAction'
			},
			observers: [
				'_updateEnrollmentAlerts(_hasEnrollments, _hasPinnedEnrollments)'
			],
			ready: function() {
				this._pinnedCoursesMap = {};
				this._updateEnrollmentAlerts(this._hasEnrollments, this._hasPinnedEnrollments);
				this._onEnrollmentPinnedMessage = this._onEnrollmentPinnedMessage.bind(this);

				this.toggleClass('d2l-my-courses-hidden', true, this.$.courseTiles);
				this.toggleClass('d2l-my-courses-hidden', true, this.$.courseList);
			},
			attached: function() {
				this.$.enrollmentsRootRequest.generateRequest();

				document.body.addEventListener('d2l-course-pinned-change', this._onEnrollmentPinnedMessage, true);

				this.$['all-courses-scroll-threshold'].scrollTarget = this.$['all-courses'].scrollRegion;
				this.$['image-selector-threshold'].scrollTarget = this.$['basic-image-selector-overlay'].scrollRegion;
			},
			detached: function() {
				document.body.removeEventListener('d2l-course-pinned-change', this._onEnrollmentPinnedMessage, true);
			},
			getCourseTileItemCount: function() {
				return this.pinnedEnrollments.length;
			},
			_onEnrollmentsRootResponse: function(response) {
				if (response.detail.status === 200) {
					var parser = document.createElement('d2l-siren-parser');
					var enrollmentsRoot = parser.parse(response.detail.xhr.response);

					if (!enrollmentsRoot.hasAction('search-my-enrollments')) {
						return;
					}

					var searchAction = enrollmentsRoot.getActionByName('search-my-enrollments');

					var pinDateQuery = {
						pageSize: 25,
						embedDepth: 1,
						sortField: 'pinDate',
						sortDescending: true
					};
					this._enrollmentsSearchUrl = this.createActionUrl(searchAction, pinDateQuery);
					this.$.enrollmentsSearchRequest.generateRequest();
				} else {
					this._showContent();
				}
			},
			_onEnrollmentsSearchResponse: function(response) {
				if (response.detail.status === 200) {
					var parser = document.createElement('d2l-siren-parser');
					var enrollments = parser.parse(response.detail.xhr.response);
					var enrollmentEntities = enrollments.getSubEntitiesByClass('enrollment');
					var newPinnedEnrollments = [];
					var newUnpinnedEnrollments = [];

					enrollmentEntities.forEach(function(enrollment) {
						var enrollmentId = this.getEntityIdentifier(enrollment);
						var orgUnitId = /organizations\/([0-9]+)/
							.exec(enrollmentId)[1];

						if (enrollment.hasClass('pinned')) {
							if (!this._pinnedCoursesMap.hasOwnProperty(enrollmentId)) {
								newPinnedEnrollments.push(enrollment);
								this._pinnedCoursesMap[enrollmentId] = true;
							}
						} else {
							newUnpinnedEnrollments.push(enrollment);
						}

						this._enrollmentIdMap[orgUnitId] = enrollmentId;
					}, this);

					this.pinnedEnrollments = this.pinnedEnrollments.concat(newPinnedEnrollments);
					this.unpinnedEnrollments = this.unpinnedEnrollments.concat(newUnpinnedEnrollments);

					this.notifySplices('pinnedEnrollments', [{
						index: this.pinnedEnrollments.length - newPinnedEnrollments.length,
						removed: [],
						addedCount: newPinnedEnrollments.length,
						object: this.pinnedEnrollments,
						type: 'splice'
					}]);

					this.notifySplices('unpinnedEnrollments', [{
						index: this.unpinnedEnrollments.length - newUnpinnedEnrollments.length,
						removed: [],
						addedCount: newUnpinnedEnrollments.length,
						object: this.unpinnedEnrollments,
						type: 'splice'
					}]);

					var colNum = this._calcNumColumns(this._getAvailableWidth(Polymer.dom(this.root).node.host), this.pinnedEnrollments.length);
					this._tileSizes = (colNum === 2) ?
						{ mobile: { maxwidth: 767, size: 50 }, tablet: { maxwidth: 1243, size: 33 }, desktop: { size: 20 } } :
						{ mobile: { maxwidth: 767, size: 100 }, tablet: { maxwidth: 1243, size: 67 }, desktop: { size: 25 } };

					this.fire('recalculate-columns');
				}

				this.toggleClass('d2l-my-courses-hidden', true, this.$.lazyLoadSpinner);
				this.$['all-courses-scroll-threshold'].clearTriggers();
				this._showContent();
			},
			_openChangeImageView: function(e) {
				if (e.detail.organization) {
					this._setImageOrg = e.detail.organization;
				}

				this.$['basic-image-selector-overlay'].open();
			},
			_openAllCoursesView: function(e) {
				e.preventDefault();
				e.stopPropagation();
				this.$$('#all-courses').open();
				this.$$('d2l-all-courses').load();

				setTimeout(function() {
					// Slight delay to allow for overlay to get a DOM width before triggering the recalculation
					this.fire('recalculate-columns');
				}.bind(this), 50);
			},
			_refreshPage: function() {
				document.location.reload(true);
			},
			_showContent: function() {
				this.toggleClass('d2l-my-courses-hidden', true, this.$.initialLoadingSpinner);
				this.toggleClass('d2l-my-courses-hidden', false, this.$$('.my-courses-content'));
			},
			_loadNextEnrollmentsPage: function() {
				if (this.$['all-courses'].opened && this._lastEnrollmentsSearchResponse) {
					var parser = document.createElement('d2l-siren-parser');
					var lastResponseEntity = parser.parse(this._lastEnrollmentsSearchResponse);

					if (lastResponseEntity.hasLink('next')) {
						this._enrollmentsSearchUrl = lastResponseEntity.getLinkByRel('next').href;
						this.$.enrollmentsSearchRequest.generateRequest();
						this.toggleClass('d2l-my-courses-hidden', false, this.$.lazyLoadSpinner);
						this.$.lazyLoadSpinner.scrollIntoView();
					}
				}
			},
			_setCourseImageEvent: function(e) {
				this._removeAlert('setCourseImageFailure');
				if (e && e.detail) {
					if (e.detail.status === 'failure') {
						setTimeout(function() {
							this._addAlert('warning', 'setCourseImageFailure', this.localize('error.settingImage'));
						}.bind(this), 1000); // delay until the tile fail icon animation begins to kick in (1 sec delay)
					}
				}
				this.$$('d2l-all-courses').setCourseImage(e);
				this.$$('d2l-course-tile-grid').setCourseImage(e);
			},
			_changeImageLoadMore: function() {
				this.$$('d2l-basic-image-selector').loadMore(this.$['image-selector-threshold']);
			},
			_clearImageScrollThreshold: function() {
				this.$['image-selector-threshold'].clearTriggers();
			},
			_onEnrollmentPinAction: function(e) {
				var isPinned = e.type === 'enrollment-pinned';
				var orgUnitId = /organizations\/([0-9]+)/
					.exec(this.getEntityIdentifier(e.detail.enrollment))[1];

				this.fire(
					'd2l-course-pinned-change', {
						orgUnitId: orgUnitId,
						isPinned: isPinned
					}
				);
			},
			_onEnrollmentPinnedMessage: function(e) {
				if (e.target !== this) {
					if (e.detail.isPinned) {
						this._pinEnrollment(e.detail.orgUnitId);
					} else {
						this._unpinEnrollment(e.detail.orgUnitId);
					}
				}
			},
			_updateEnrollmentAlerts: function(hasEnrollments, hasPinnedEnrollments) {
				this._clearAlerts();

				if (hasEnrollments) {
					if (!hasPinnedEnrollments) {
						this._addAlert('call-to-action', 'noPinnedCourses', this.localize('noPinnedCoursesMessage'));
					}
				} else {
					this._addAlert('call-to-action', 'noCourses', this.localize('noCoursesMessage'));
				}
			},
			_onSimpleOverlayClosed: function() {
				this._removeAlert('setCourseImageFailure');
			}
		});
	</script>
</dom-module>
