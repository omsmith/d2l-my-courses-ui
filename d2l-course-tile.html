<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-siren-parser/d2l-siren-parser.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../d2l-ajax/d2l-ajax.html">
<link rel="import" href="d2l-course-tile-styles.html">
<link rel="import" href="../d2l-icons/d2l-icons.html">
<link rel="import" href="localize-behavior.html">
<link rel="import" href="d2l-touch-menu.html">
<link rel="import" href="d2l-touch-menu-item.html">

<!--
`<d2l-course-tile>` is a clickable, interactable tile that represents a course

An important distinction to make in understanding the functionality of the course tile is the difference between an
enrollment and an organization. An organization is what some might call a "course" - it has a name, an image, etc.,
but it is largely static and doesn't speak to a user's relationship to it. An enrollment, on the other hand, represents
a user's involvement in an organization, and so has things like a start date, end date, and the role that the user has
in that organization - student, teacher, TA, etc.
-->
<dom-module id="d2l-course-tile">
	<template>
		<style include="d2l-course-tile-styles"></style>

		<d2l-ajax
			id="organizationRequest"
			url="[[_organizationUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-iron-ajax-response="_onOrganizationResponse">
		</d2l-ajax>

		<d2l-ajax
			id="enrollmentPinRequest"
			url="[[_enrollmentPinUrl]]"
			method="[[_enrollmentPinMethod]]"
			body="[[_enrollmentPinBody]]"
			headers='{ "Accept": "application/vnd.siren+json", "Content-Type": "application/x-www-form-urlencoded" }'
			on-iron-ajax-response="_onEnrollmentPinResponse"
			on-iron-ajax-error="_onEnrollmentPinError">
		</d2l-ajax>

		<div class="tile-container"
			on-mouseover="_hoverCourseTile"
			on-mouseout="_onTileMouseOut">
			<a href$="[[_organizationHomepageUrl]]" class="no-tap-interaction"
				on-focus="_hoverCourseTile"
				on-blur="_unhoverCourseTile">
				<div class="course-image-container">
					<div class="course-image">
						<img aria-hidden="true" />
					</div>
				</div>
				<div class="course-text d2l-heading-4">{{_organization.properties.name}}</div>
			</a>

			<div class="hover-menu no-tap-interaction">
				<button class="menu-item no-tap-interaction"
					on-click="_hoverPinClickHandler"
					on-focus="_hoverPinMenuItem"
					on-blur="_unhoverPinMenuItem"
					on-mouseover="_hoverPinMenuItem"
					on-mouseout="_unhoverPinMenuItem">
					<iron-icon class="menu-icon" icon="d2l-tier1:pin-filled" aria-hidden="true"></iron-icon>
					<span class="menu-text pin"
						aria-label$="[[localize('pinCourse', 'course', _organization.properties.name)]]"
						>{{localize('pin')}}</span>
					<span class="menu-text unpin"
						aria-label$="[[localize('unpinCourse', 'course', _organization.properties.name)]]"
						>{{localize('unpin')}}</span>
				</button>
			</div>
		</div>
	</template>

	<script>
		'use strict';

		Polymer({
			is: 'd2l-course-tile',

			/*
			* Fired when the course tile's pin action is selected
			* @event enrollment-pinned
			*/

			/*
			* Fired when the course tile's unpin action is selected
			* @event enrollment-unpinned
			*/

			/*
			* Fired when the tile removal animation from the grid is completed
			* @event tile-remove-complete
			*/

			/*
			* Fired when the tile insertion animation to the grid is completed
			* @event tile-insert-complete
			*/

			properties: {
				/*
				* TODO: Figure out what this is... Friday night brain isn't allowing me to understand this.
				* @type {Boolean}
				*/
				animateInsertion: {
					type: Boolean
				},
				/*
				* Delays initial loading of the organization until explicitly triggered by `loadOrganization`
				* @type {Boolean}
				*/
				delayLoad: {
					type: Boolean,
					observer: '_delayLoadChanged'
				},
				/*
				* Course tile enrollment
				*
				* When the enrollment is set, the course tile will automatically fetch information about the
				* organization the enrollment is in.
				*
				* @type {Entity}
				*/
				enrollment: Object,
				/*
				* TODO: Erm... same thing. Something something animation?
				* @type {Boolean}
				*/
				enrollmentId: Number,
				/*
				* Specifies whether the (desktop) hover menu is enabled on the course tile
				* @type {Boolean}
				*/
				hoverEnabled: {
					type: Boolean,
					value: true
				},
				/*
				* Whether the enrollment represented by this course tile is pinned or not
				* @type {Boolean}
				*/
				pinned: {
					type: Boolean,
					observer: '_pinnedChanged'
				},
				/*
				* Specifies whether the (mobile) touch menu is enabled on the course tile
				* @type {Boolean}
				*/
				touchEnabled: {
					type: Boolean,
					value: true
				},
				/*
				* Body sent for pin/unpin action
				* @type {String}
				*/
				_enrollmentPinBody: String,
				/*
				* HTTP method used by the pin/unpin action
				* @type {String}
				*/
				_enrollmentPinMethod: String,
				/*
				* URL used by the pin/unpin action
				* @type {String}
				*/
				_enrollmentPinUrl: String,
				/*
				* The organization, fetched by the course tile when the `enrollment` Entity is changed
				* @type {Entity}
				*/
				_organization: Object,
				/*
				* The URL to of the `_organization`'s homepage - when the course tile is clicked, this is the URL we go to
				* @type {String}
				*/
				_organizationHomepageUrl: String,
				/*
				* The URL to fetch the `_organization` Entity from (determined from the `enrollment`'s Links)
				* @type {String}
				*/
				_organizationUrl: String
			},
			behaviors: [
				Polymer.D2L.MyCourses.LocalizeBehavior
			],
			listeners: {
				'animationend': '_onAnimationComplete'
			},
			created: function() {
				this.setAttribute('role', 'link');
			},
			attached: function() {
				if (this.animateInsertion) {
					this.toggleClass('animate-insertion-pre', true, this);
				}
			},
			ready: function() {
				// Currently only needed in tests, but it is entirely possible
				// to render the element without an enrollment initially
				if (!this.enrollment) {
					return;
				}

				this.pinned = this.enrollment.hasClass('pinned');

				var organizationLink = this.enrollment.getLinkByRel(/\/organization$/);
				this._organizationUrl = organizationLink.href + '?embedDepth=1';
				if (!this.delayLoad) {
					this.$.organizationRequest.generateRequest();
				}
			},
			/*
			* Handler that triggers the API call to change an enrollment's pin state when the user says DO IT
			* TODO: what do `isTouch`?
			* @param {Boolean} isTouch If a touch interface, `isTouch=true` will... do... something with styles.
			*/
			pinClickHandler: function(isTouch) {
				var pinAction = this.pinned ? this.enrollment.getActionByName('unpin-course') : this.enrollment.getActionByName('pin-course');

				this._enrollmentPinMethod = pinAction.method;
				this._enrollmentPinUrl = pinAction.href;

				// This value is purely for UI responsiveness - if the request fails, this value will be set back to
				// the previous value in the error handler; if the request succeeds, we also set it in the response
				// handler (to this same value), but that could take a few hundred ms, so do it before the request too.
				this.pinned = !this.pinned;

				var body = {};
				var fields = pinAction.fields || [];
				fields.forEach(function(field) {
					body[field.name] = field.value;
				});
				this._enrollmentPinBody = body;

				this.$.enrollmentPinRequest.generateRequest();

				var eventName = this.pinned ? 'enrollment-pinned' : 'enrollment-unpinned';
				this.fire(eventName, {
					enrollment: this.enrollment,
					organization: this._organization
				});

				this._pinAnimationInProgress = true;
				this.toggleClass('unpin-hovered', false, this);

				if (isTouch) {
					this.customStyle['--scale-fade-min-scale'] = '1.1';
					this.updateStyles();
				}

				this.toggleClass('unpin', true, this);

				this._pendingPinAction = this.pinned;
			},
			/*
			* Sets classes for this tile having the touch menu on it
			* @param {Boolean} isOpen Whether the menu is being opened or closed
			*/
			setTouchMenuOpen: function(isOpen) {
				this.toggleClass('touch-menu-open', isOpen, this);
				this.toggleClass('hover', isOpen, this);
			},
			_pendingPinAction: false,
			_pinAnimationInProgress: false,
			_delayLoadChanged: function(delayLoad) {
				if (this.isAttached && !delayLoad && !this._organization) {
					this.$.organizationRequest.generateRequest();
				}
			},
			_launchCourseTileImageSelector: function(e) {
				e.preventDefault();
				e.stopPropagation();

				this.fire('open-change-image-view', {
					enrollment: this.enrollment
				});
			},
			_hoverCourseTile: function() {
				if (this.hoverEnabled) {
					this._setCourseTileHovered(true);
				}
			},
			_hoverPinClickHandler: function(e) {
				// Prevent the click from triggering navigation to the course
				e.preventDefault();

				this.pinClickHandler(false);
			},
			_hoverPinMenuItem: function() {
				this._onUnpinHover({detail: {hoverState: true}});
				this._hoverCourseTile();
			},
			_onAnimationComplete: function(e) {
				var tileContainer = this.$$('.tile-container');

				if (e.animationName.indexOf('scale-and-fade-out') > -1) {
					this.fire('tile-remove-complete', {enrollment: this.enrollment, pinned: this._pendingPinAction});
				} else if (e.animationName.indexOf('scale-and-fade-in') > -1) {
					this.toggleClass('animate-insertion', false, tileContainer);
					this.toggleClass('animate-insertion', false, this);
					this.toggleClass('animate-insertion', false, this.$$('.tile-container'));
					this.fire('tile-insert-complete', {enrollment: this.enrollment, pinned: this._pendingPinAction});
				} else if (e.animationName.indexOf('tile-pre-insertion') > -1) {
					this.toggleClass('animate-insertion-pre', false, this);
					this.toggleClass('animate-insertion', true, tileContainer);
					this.toggleClass('animate-insertion', true, this);
				}
			},
			_onEnrollmentPinError: function() {
				// Just revert back to whatever pin state we already had stored
				this.pinned = this.enrollment.hasClass('pinned');
			},
			_onEnrollmentPinResponse: function(response) {
				if (response.detail.status === 200) {
					// The pin action returns the updated enrollment, so update
					// this.enrollment with the modified one
					var parser = document.createElement('d2l-siren-parser');
					this.enrollment = parser.parse(response.detail.xhr.response);
					this.pinned = this.enrollment.hasClass('pinned');
				}
			},
			_onOrganizationResponse: function(response) {
				if (response.detail.status === 200) {
					var parser = document.createElement('d2l-siren-parser');
					var organization = parser.parse(response.detail.xhr.response);

					var courseImageEntity = organization.getSubEntityByClass('course-image');
					if (courseImageEntity) {
						var courseImageLink = courseImageEntity.getLinkByRel('alternate');
						var courseImage = this.$$('.course-image img');
						Polymer.dom(courseImage).setAttribute('src', courseImageLink.href);
					}

					this._organization = organization;
					this._organizationHomepageUrl = organization.getLinkByRel(/\/organization-homepage$/).href;
				}
			},
			_onTileMouseOut: function() {
				this._unhoverCourseTile(true);
			},
			_onUnpinHover: function(e) {
				this.toggleClass('unpin-hovered', e.detail.hoverState, this);
			},
			_pinnedChanged: function(pinned) {
				var pinIcon = this.$$('.menu-item iron-icon.menu-icon'),
					pinText = this.$$('.menu-item .menu-text.pin'),
					unpinText = this.$$('.menu-item .menu-text.unpin');

				if (pinned) {
					Polymer.dom(pinIcon).setAttribute('icon', 'd2l-tier1:pin-hollow');
					Polymer.dom(pinText).setAttribute('style', 'display: none');
					Polymer.dom(unpinText).setAttribute('style', 'display: inline');
				} else {
					Polymer.dom(pinIcon).setAttribute('icon', 'd2l-tier1:pin-filled');
					Polymer.dom(pinText).setAttribute('style', 'display: inline');
					Polymer.dom(unpinText).setAttribute('style', 'display: none');
				}
			},
			_setCourseTileHovered: function(isHovered) {
				this.toggleClass('hover', isHovered, this.$$('.tile-container'));
				this.toggleClass('hover', isHovered, this.$$('.hover-menu'));
				this.toggleClass('hover', isHovered, this.$$('.course-image-container'));
			},
			_unhoverCourseTile: function(force) {
				if ((force === true || Polymer.dom(this.root).querySelectorAll(':hover').length === 0) &&
					!this._pinAnimationInProgress) {
					this._setCourseTileHovered(false);
				}
			},
			_unhoverPinMenuItem: function() {
				this._onUnpinHover({detail: {hoverState: false}});
				this._unhoverCourseTile();
			}
		});
	</script>
</dom-module>
