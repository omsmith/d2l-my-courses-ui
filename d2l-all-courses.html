<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../d2l-colors/d2l-colors.html">
<link rel="import" href="../d2l-dropdown/d2l-dropdown.html">
<link rel="import" href="../d2l-dropdown/d2l-dropdown-content.html">
<link rel="import" href="../d2l-dropdown/d2l-dropdown-menu.html">
<link rel="import" href="../d2l-icons/d2l-icons.html">
<link rel="import" href="../d2l-menu/d2l-menu-item-radio.html">
<link rel="import" href="../d2l-siren-parser/d2l-siren-parser.html">
<link rel="import" href="d2l-alert.html">
<link rel="import" href="d2l-alert-behavior.html">
<link rel="import" href="d2l-course-management-behavior.html">
<link rel="import" href="d2l-course-tile-grid.html">
<link rel="import" href="d2l-course-tile-responsive-grid-behavior.html">
<link rel="import" href="d2l-filter-menu-content.html">
<link rel="import" href="d2l-search-widget-custom.html">
<link rel="import" href="localize-behavior.html">

<dom-module id="d2l-all-courses">
	<template>
		<style>
			:host {
				display: block;
			}
			h2 {
				/* overrides to d2l-heading-3 */
				margin: 20px 0 10px 0;
				font-size: 20px;
				/* end overrides */
			}
			d2l-alert {
				display: block;
				margin-bottom: 20px;
			}
			d2l-icon {
				--d2l-icon-height: 15px;
				--d2l-icon-width: 15px;
				margin-top: -0.35rem;
			}
			.d2l-all-courses-hidden {
				display: none !important;
			}
			.search-and-filter {
				display: flex;
				align-items: center;
				justify-content: space-between;
				margin-bottom: 50px;
			}
			.search-and-filter > d2l-search-widget-custom {
				flex: calc(5 / 12);
			}
			@media screen and (max-width: 767px) {
				.search-and-filter > d2l-search-widget-custom {
					flex: 1;
				}
				#filterAndSort {
					display: none;
				}
			}
			.search-and-filter > div {
				flex: calc(7 / 12);
				display: flex;
				justify-content: flex-end;
			}
			.dropdown-opener-text {
				@apply(--d2l-body-small-text);
				/* overrides to d2l-body-small-text */
				font-size: 1rem;
				color: var(--d2l-color-tungsten);
				/* end overrides */
				cursor: pointer;
				padding: 0;
				margin-left: 1rem;
			}
			.dropdown-button {
				background: none;
				border: none;
				cursor: pointer;
				padding: 0;
				color: var(--d2l-color-tungsten);
			}
			.dropdown-content-header {
				display: flex;
				align-items: center;
				justify-content: space-between;
				border-bottom: 1px solid var(--d2l-color-gypsum);
				width: 100%;
				padding: 20px;
			}
			@media screen and (-ms-high-contrast: active), (-ms-high-contrast: none) {
				#filterText {
					padding-top: 4px;
				}
			}
			#filterSection {
				display: flex;
			}
			#filterText {
				padding-right: 4px;
			}
			button[aria-pressed="true"] {
				color: var(--d2l-color-celestine);
			}
			button:focus > d2l-icon,
			button:hover > d2l-icon,
			button:focus > span,
			button:hover > span,
			#filterText:hover,
			#filterText:focus,
			#filterText:hover + d2l-dropdown button d2l-icon,
			#filterText:focus + d2l-dropdown button d2l-icon,
			.focus {
				text-decoration: underline;
				color: var(--d2l-color-celestine);
			}
		</style>

		<div class="search-and-filter">
			<d2l-search-widget-custom
				hidden$="[[!_hasEnrollments]]"
				my-enrollments-entity="[[myEnrollmentsEntity]]"
				parent-organizations="[[_parentOrganizations]]"
				sort-field="[[_sortField]]">
			</d2l-search-widget-custom>

			<div id="filterAndSort" class="d2l-all-courses-hidden">
				<div id="filterSection" class="d2l-all-courses-hidden">
					<span id="filterText" class="dropdown-opener-text" on-tap="_toggleFilterDropdown">[[_filterText]]</span>
					<d2l-dropdown id="filterDropdown">
						<button
							id="filterDropdownOpener"
							class="d2l-dropdown-opener dropdown-button"
							on-focus="_focusFilterText"
							on-blur="_blurFilterText"
							on-mouseenter="_focusFilterText"
							on-mouseleave="_blurFilterText"
							aria-labelledby="filterText">
							<d2l-icon icon="d2l-tier1:chevron-down" aria-hidden="true"></d2l-icon>
						</button>
						<d2l-dropdown-content id="filterDropdownContent" no-padding min-width="350">
							<d2l-filter-menu-content
								id="filterMenuContent"
								my-enrollments-entity="[[myEnrollmentsEntity]]">
							</d2l-filter-menu-content>
							<iron-scroll-threshold
								id="scrollThreshold"
								on-lower-threshold="_onLowerThreshold">
							</iron-scroll-threshold>
						</d2l-dropdown-content>
					</d2l-dropdown>
				</div>

				<d2l-dropdown id="sortDropdown">
					<button
						class="d2l-dropdown-opener dropdown-button"
						aria-labelledby="sortText">
						<span id="sortText" class="dropdown-opener-text">{{localize('sorting.sortDatePinned')}}</span>
						<d2l-icon icon="d2l-tier1:chevron-down" aria-hidden="true"></d2l-icon>
					</button>
					<d2l-dropdown-menu no-padding min-width="350">
						<d2l-menu label="{{localize('sorting.sortBy')}}">
							<div class="dropdown-content-header">
								<span class="dropdown-content-header-text">{{localize('sorting.sortBy')}}</span>
							</div>
							<d2l-menu-item-radio class="dropdown-content-gradient" value="courseCode" text="{{localize('sorting.courseCode')}}"></d2l-menu-item-radio>
							<d2l-menu-item-radio value="courseName" text="{{localize('sorting.courseName')}}"></d2l-menu-item-radio>
							<d2l-menu-item-radio value="pinDate" text="{{localize('sorting.datePinned')}}" selected></d2l-menu-item-radio>
							<d2l-menu-item-radio value="lastAccessed" text="{{localize('sorting.lastAccessed')}}"></d2l-menu-item-radio>
						</d2l-menu>
					</d2l-dropdown-menu>
				</d2l-dropdown>
			</div>
		</div>

		<h2 class="d2l-heading-3">{{localize('pinnedCourses')}}</h2>

		<template is="dom-repeat" items="{{_alerts}}">
			<d2l-alert type="[[item.alertType]]">
				{{item.alertMessage}}
			</d2l-alert>
		</template>

		<d2l-course-tile-grid
			id="all-courses-pinned"
			enrollments="{{pinnedEnrollments}}"
			enrollments-queue="{{pinnedEnrollmentsQueue}}"
			delay-course-tile-load="[[delayCourseTileLoad]]"
			tile-sizes="[[_tileSizes]]">
		</d2l-course-tile-grid>

		<h2 class="d2l-heading-3">{{localize('unpinnedCourses')}}</h2>

		<d2l-course-tile-grid
			id="all-courses-unpinned"
			enrollments="{{unpinnedEnrollments}}"
			enrollments-queue="{{unpinnedEnrollmentsQueue}}"
			delay-course-tile-load="[[delayCourseTileLoad]]"
			tile-sizes="[[_tileSizes]]">
		</d2l-course-tile-grid>
	</template>

	<script>
		'use strict';

		Polymer({
			is: 'd2l-all-courses',
			properties: {
				// Sets the delay-load property on the course tile grid
				delayCourseTileLoad: {
					type: Boolean,
					value: true
				},
				myEnrollmentsEntity: {
					type: Object,
					value: function() {
						return {};
					}
				},
				_filterText: String,
				_sortField: {
					type: String,
					value: 'pinDate'
				},
				_tileSizes: Object,
				_parentOrganizations: {
					type: Array,
					value: function() {
						return [];
					}
				}
			},
			behaviors: [
				window.D2L.MyCourses.CourseTileResponsiveGridBehavior,
				window.D2L.MyCourses.LocalizeBehavior,
				window.D2L.MyCourses.CourseManagementBehavior,
				window.D2L.MyCourses.UtilityBehavior,
				window.D2L.MyCourses.AlertBehavior
			],
			listeners: {
				'd2l-simple-overlay-opening': '_onSimpleOverlayOpening'
			},
			observers: [
				'_updateEnrollmentAlerts(_hasPinnedEnrollments)'
			],
			ready: function() {
				this.usePendingLists = true;
				this._updateEnrollmentAlerts(this._hasPinnedEnrollments);

				// Both course tile grids in this view should have the same number of columns, so use a custom getter
				var courseTileGrids = Polymer.dom(this.root).querySelectorAll('d2l-course-tile-grid');
				for (var i = 0; i < courseTileGrids.length; i++) {
					courseTileGrids[i].getCourseTileItemCount = this.getCourseTileItemCount.bind(this);
				}
				this._updateTileSizes();

				this._filterText = this.localize('filtering.filter');
			},
			attached: function() {
				this.listen(this.$.sortDropdown, 'd2l-menu-item-change', '_updateSortBy');
				this.listen(this.$.filterDropdownContent, 'd2l-dropdown-close', '_onFilterDropdownClose');
				this.listen(this.$.filterMenuContent, 'd2l-filter-menu-content-filters-changed', '_onFilterChanged');
				this.listen(this.$.filterMenuContent, 'd2l-filter-menu-content-hide', '_onFilterHideChanged');

				this.$.scrollThreshold.scrollTarget = this.$.filterDropdownContent.querySelector('.d2l-dropdown-content-container');

				window.addEventListener('resize', this._onResize.bind(this));

				this._parser = document.createElement('d2l-siren-parser');
			},
			detached: function() {
				this.unlisten(this.$.sortDropdown, 'd2l-menu-item-change', '_updateSortBy');
				this.unlisten(this.$.filterDropdownContent, 'd2l-dropdown-close', '_onFilterDropdownClose');
				this.unlisten(this.$.filterMenuContent, 'd2l-filter-menu-content-filters-changed', '_onFilterChanged');
				this.unlisten(this.$.filterMenuContent, 'd2l-filter-menu-content-hide', '_onFilterHideChanged');
			},
			getCourseTileItemCount: function() {
				var itemCount = Math.max(this.pinnedEnrollments.length, this.unpinnedEnrollments.length);
				return itemCount;
			},
			load: function() {
				// Load course tile and filter contents. Called from d2l-my-courses.
				this.delayCourseTileLoad = false;

				// Only make the call to load the filter menu contents if user has a
				// substantial number of enrollments - otherwise, hide the filter menu
				if (this.pinnedEnrollments.length + this.unpinnedEnrollments.length >= 20) {
					this.$.filterMenuContent.load();
					this.toggleClass('d2l-all-courses-hidden', false, this.$.filterAndSort);
				}
			},
			setCourseImage: function(details) {
				this._removeAlert('setCourseImageFailure');
				if (details && details.detail) {
					if (details.detail.status === 'failure') {
						this._addAlert('warning', 'setCourseImageFailure', this.localize('error.settingImage'));
					}
				}
				this.$$('#all-courses-pinned').setCourseImage(details);
				this.$$('#all-courses-unpinned').setCourseImage(details);
			},
			_filterDropdownOpen: false,
			_parser: null,
			_sortTextOptions: {
				'courseCode': 'sorting.sortCourseCode',
				'courseName': 'sorting.sortCourseName',
				'pinDate': 'sorting.sortDatePinned',
				'lastAccessed': 'sorting.sortLastAccessed'
			},
			_blurFilterText: function() {
				// Only de-highlight text if focus has moved AND we're not hovering over the opener button anymore
				// Without this check, the text de-highlights once the dropdown is opened as focus moves to the tabs
				if (this.$$('#filterDropdownOpener:focus') === null && this.$$('#filterDropdownOpener:hover') === null) {
					this.toggleClass('focus', false, this.$.filterText);
				}
			},
			_focusFilterText: function() {
				this.toggleClass('focus', true, this.$.filterText);
			},
			_onFilterChanged: function(e) {
				this.set('_parentOrganizations', e.detail.value);
				this.set('_filterText', e.detail.text);
			},
			_onFilterDropdownClose: function() {
				// If the dropdown is closed by clicking elsewhere, we need to manually update _filterDropdownOpen
				// since _toggleFilterDropdown doesn't run.
				// Timeout is to ensure this runs after _toggleFilterDropdown when it's clicked closed
				setTimeout(function() {
					this.set('_filterDropdownOpen', false);
				}.bind(this), 100);
			},
			_onFilterHideChanged: function(e) {
				this.toggleClass('hidden', e.detail.hide, this.$.filterSection);
			},
			_onLowerThreshold: function() {
				this.$.scrollThreshold.clearTriggers();
				this.$.filterMenuContent._loadMore();
			},
			_onResize: function() {
				this._updateTileSizes();
			},
			_onSimpleOverlayOpening: function() {
				this._removeAlert('setCourseImageFailure');
			},
			_toggleFilterDropdown: function() {
				// This is somewhat gross, but is a side effect of using the filter text span as a secondary opener
				if (this._filterDropdownOpen) {
					this.$.filterDropdownContent.close();
					this.$.filterDropdownOpener.focus();
				} else {
					this.$.filterDropdownContent.open();
					this.$.filterMenuContent.load();
				}
				this.set('_filterDropdownOpen', !this._filterDropdownOpen);
			},
			_updateSortBy: function(e) {
				this.set('_sortField', e.detail.value);
				this.$.sortText.textContent = this.localize(this._sortTextOptions[this._sortField] || '');
				this.$.sortDropdown.toggleOpen();
			},
			_updateEnrollmentAlerts: function(hasPinnedEnrollments) {
				this._clearAlerts();

				if (!hasPinnedEnrollments) {
					this._addAlert('call-to-action', 'noPinnedCourses', this.localize('noPinnedCoursesMessage'));
				}
			},
			_updateTileSizes: function() {
				this._rescaleCourseTileRegions();
				this._tileSizes = Math.floor(100 / this._numColsOverlay) + 'vw';
			}
		});
	</script>
</dom-module>
