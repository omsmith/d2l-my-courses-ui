<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../d2l-ajax/d2l-ajax.html">
<link rel="import" href="../d2l-dropdown/d2l-dropdown.html">
<link rel="import" href="../d2l-dropdown/d2l-dropdown-content.html">
<link rel="import" href="../d2l-dropdown/d2l-dropdown-menu.html">
<link rel="import" href="../d2l-icons/d2l-icons.html">
<link rel="import" href="../d2l-menu/d2l-menu-item-styles.html">
<link rel="import" href="../d2l-menu/d2l-menu-item-behavior.html">
<link rel="import" href="../d2l-menu/d2l-menu-item.html">
<link rel="import" href="../d2l-search-widget/d2l-search-widget.html">
<link rel="import" href="d2l-alert.html">
<link rel="import" href="d2l-course-management-behavior.html">
<link rel="import" href="d2l-course-tile-grid.html">
<link rel="import" href="d2l-course-tile-responsive-grid-behavior.html">
<link rel="import" href="d2l-search-widget-custom.html">
<link rel="import" href="localize-behavior.html">

<script>
	'use strict';

	(function() {
		Polymer.D2L = Polymer.D2L || {};
		Polymer.D2L.MyCourse = Polymer.D2L.MyCourses || {};

		/** @polymerBehavior */
		Polymer.D2L.MyCourses.CustomMenuItemBehaviorImpl = {
			/*
			* Fired when the sliding animation of course tiles is finished
			* @event menu-item-selected
			* @param {String} value `value` property of the item
			* @param {Boolean} selected True if item is selected
			*/

			properties: {
				isToggle: {
					type: Boolean,
					value: false
				},
				selected: {
					type: Boolean,
					value: false,
					observer: '_onSelectedChanged',
					reflectToAttribute: true
				},
				value: String
			},
			listeners: {
				'tap': '_onTap',
				'keydown': '_onKeydown'
			},
			_onSelectedChanged: function(selected) {
				this.toggleClass('hidden', !selected, this.$$('d2l-icon'));
				selected ? this.setAttribute('aria-selected', true) : this.removeAttribute('aria-selected');
			},
			_onKeydown: function(e) {
				// Select on either Enter or Space
				if (e.keyCode === 13 || e.keyCode === 32) {
					this._onTap(e);
				}
			},
			_onTap: function(e) {
				this.set('selected', this.isToggle ? !this.selected : true);
				e.preventDefault();
				this.fire('menu-item-selected', {
					value: this.value,
					selected: this.selected
				});
			}
		};

		/** @polymerBehavior */
		Polymer.D2L.MyCourses.CustomMenuItemBehavior = [
			Polymer.D2L.MyCourses.CustomMenuItemBehaviorImpl,
			window.D2L.PolymerBehaviors.MenuItemBehavior
		];
	})();
</script>

<dom-module id="d2l-menu-item-sort">
	<template>
		<style include"d2l-menu-item-styles">
			:host {
				display: block;
				padding: 0.9rem 1rem;
			}
			:host span {
				line-height: 1.2rem;
			}
			:host(:hover),
			:host(:focus) {
				color: var(--d2l-color-tungsten);
			}
			.hidden {
				visibility: hidden;
			}
		</style>

		<d2l-icon icon="d2l-tier1:check" aria-hidden="true"></d2l-icon>
		<span>[[text]]</span>
	</template>
	<script>
		'use strict';
		Polymer({
			is: 'd2l-menu-item-sort',
			behaviors: [
				Polymer.D2L.MyCourses.CustomMenuItemBehavior
			]
		});
	</script>
</dom-module>

<dom-module id="d2l-menu-item-filter">
	<template>
		<style include="d2l-menu-item-styles">
			:host {
				display: block;
				font-size: 0.8rem;
				padding: 0.5rem 1rem;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
				border: none !important;
			}
			:host(:focus) > div,
			:host(:hover) > div {
				border-color: var(--d2l-color-celestine);
			}
			.hidden {
				visibility: hidden;
			}
			.checkbox {
				display: inline-block;
				width: 1rem;
				height: 1rem;
				border: 2px solid var(--d2l-color-titanius);
				border-radius: 0.3rem;
				background-color: var(--d2l-color-woolonardo);
				box-sizing: border-box;
				margin-top: -0.2rem;
				margin-right: 0.5rem;
				vertical-align: middle;
			}
			d2l-icon {
				margin-top: -0.4rem;
				margin-left: 0.05rem;
				--d2l-icon-height: 0.7rem;
				--d2l-icon-width: 0.7rem;
			}
		</style>

		<div class="checkbox">
			<d2l-icon icon="d2l-tier1:check" aria-hidden="true"></d2l-icon>
		</div>
		<span>[[text]]</span>
	</template>
	<script>
		'use strict';
		Polymer({
			is: 'd2l-menu-item-filter',
			behaviors: [
				Polymer.D2L.MyCourses.CustomMenuItemBehavior
			],
			ready: function() {
				this.isToggle = true;
			}
		});
	</script>
</dom-module>

<!--
`<d2l-all-courses>` displays both pinned and unpinned courses

@demo demo/d2l-all-courses-demo.html
-->
<dom-module id="d2l-all-courses">
	<template>
		<style>
			:host {
				display: block;
			}
			h2 {
				/* overrides to d2l-heading-3 */
				margin: 20px 0 10px 0;
				font-size: 20px;
				/* end overrides */
			}
			d2l-alert {
				margin-bottom: 20px;
			}
			.hidden {
				display: none;
			}
			.invisible {
				visibility: hidden;
			}
			.search-and-filter {
				display: flex;
				align-items: center;
				justify-content: space-between;
				margin-bottom: 60px;
			}
			.search-and-filter > * {
				flex: 1
			}
			.dropdown-text {
				@apply(--d2l-small-text);
				/* overrides to d2l-small-text */
				font-size: 1rem;
				font-weight: 300;
				color: var(--d2l-color-tungsten);
				/* end overrides */
				cursor: pointer;
				padding: 0;
				margin-left: 1rem;
			}
			#filterAndSort {
				margin-left: auto;
			}
			#filterAndSort > div {
				float: right;
			}
			#filterSection,
			#sortSection {
				float: left;
			}
			#filterSection:hover > span,
			#filterSection:hover d2l-dropdown button d2l-icon,
			#sortSection:hover > span,
			#sortSection:hover d2l-dropdown button d2l-icon,
			#filterSection d2l-dropdown button:focus d2l-icon,
			#sortSection d2l-dropdown button:focus d2l-icon,
			.focus {
				text-decoration: underline;
				color: var(--d2l-color-celestine);
			}
			d2l-dropdown > button:hover,
			d2l-dropdown > button:focus {
				color: var(--d2l-color-celestine);
			}
			.dropdown-button {
				background: none;
				border: none;
				cursor: pointer;
				padding: 0;
				color: var(--d2l-color-tungsten);
			}
			d2l-icon {
				--d2l-icon-height: 15px;
				--d2l-icon-width: 15px;
				margin-top: -0.35rem;
			}
			.clear-button {
				@apply(--d2l-small-text);
				/* overrides to d2l-small-text */
				color: var(--d2l-color-celestine);
				/* end overrides */
				background: none;
				border: none;
				cursor: pointer;
				margin: 0;
				padding: 0;
			}
			.dropdown-content-header {
				display: flex;
				align-items: center;
				justify-content: space-between;
				border-bottom: 1px solid var(--d2l-color-gypsum);
				width: 100%;
				padding: 20px;
			}
			.dropdown-content-header-text {
				font-weight: bold;
			}
			.dropdown-content-gradient {
				background: linear-gradient(to top, white, var(--d2l-color-regolith));
			}
			.dropdown-content-tabs {
				display: flex;
				align-items: center;
				justify-content: space-between;
			}
			.dropdown-content-tab {
				flex: 1;
			}
			d2l-search-widget {
				margin-left: 20px;
				margin-right: 20px;
				margin-top: 10px;
				margin-bottom: 10px;
			}
			.dropdown-content-tab-button {
				@apply(--d2l-small-text);
				background: none;
				border: none;
				padding: 10px;
				cursor: pointer;
				display: inherit;
			}
			.dropdown-content-tab-highlight {
				background-color: var(--d2l-color-celestine);
				border-bottom-left-radius: 4px;
				border-bottom-right-radius: 4px;
				height: 4px;
				width: 80%;
				margin: auto;
			}
			button:focus,
			button:hover,
			.highlight {
				text-decoration: underline;
			}
			.selected {
				color: var(--d2l-color-celestine);
			}
			.selected > d2l-icon {
				visibility: visible;
			}
		</style>

		<d2l-ajax
			id="moreDepartmentsRequest"
			url="[[_moreDepartmentsUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-iron-ajax-response="_onMoreDepartmentsResponse">
		</d2l-ajax>

		<d2l-ajax
			id="moreSemestersRequest"
			url="[[_moreSemestersUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-iron-ajax-response="_onMoreSemestersResponse">
		</d2l-ajax>

		<div class="search-and-filter">
			<d2l-search-widget-custom
				hidden$="[[_hasEnrollments]]"
				search-root-url="[[searchUrl]]"
				parent-organization-ids="[[_parentOrganizationIds]]"
				sort-field="[[_sortField]]">
			</d2l-search-widget-custom>

			<div id="filterAndSort">
				<div>
					<div id="filterSection">
						<span id="filterText" class="dropdown-text" on-tap="_toggleFilterDropdown">{{localize('filtering.filter')}}</span>
						<d2l-dropdown id="filterDropdown">
							<button
								class="d2l-dropdown-opener dropdown-button"
								on-focus="_focusFilterText"
								on-blur="_blurFilterText">
								<d2l-icon icon="d2l-tier1:chevron-down" aria-hidden="true"></d2l-icon>
							</button>
							<d2l-dropdown-content id="filterDropdownContent" no-padding min-width="350">
								<div class="dropdown-content-header">
									<span class="dropdown-content-header-text">{{localize('filtering.filterBy')}}</span>
									<template is="dom-if" if="[[_isFiltered]]">
										<button class="clear-button" on-tap="_clearFilters">{{localize('filtering.clear')}}</button>
									</template>
								</div>
								<div class="dropdown-content-tabs dropdown-content-gradient">
									<div class="dropdown-content-tab">
										<div class="dropdown-content-tab-highlight" id="semesterListHighlight"></div>
										<button
											id="semesterListButton"
											class="dropdown-content-tab-button"
											on-tap="_selectSemesterList"
											aria-pressed="true">
											{{localize('filtering.semester')}}
										</button>
									</div>
									<div class="dropdown-content-tab">
										<div class="dropdown-content-tab-highlight" id="departmentListHighlight"></div>
										<button
											id="departmentListButton"
											class="dropdown-content-tab-button"
											on-tap="_selectDepartmentList"
											aria-pressed="false">
											{{localize('filtering.department')}}
										</button>
									</div>
								</div>
								<div id="semesterList">
									<d2l-search-widget
										id="semesterSearchWidget"
										search-action="[[_searchSemestersAction]]"
										search-field-name="search"></d2l-search-widget>
									<d2l-menu label="{{localize('filtering.semester')}}">
										<template is="dom-repeat" items="[[_semesterOrganizations]]">
											<d2l-menu-item-filter
												value="[[item.properties.id]]"
												text="[[item.properties.name]]"
												selected="[[item.properties.selected]]">
											</d2l-menu-item-filter>
										</template>
									</d2l-menu>
								</div>
								<div id="departmentList">
									<d2l-search-widget
										id="departmentSearchWidget"
										search-action="[[_searchDepartmentsAction]]"
										search-field-name="search"></d2l-search-widget>
									<d2l-menu label="{{localize('filtering.department')}}">
										<template is="dom-repeat" items="[[_departmentOrganizations]]">
											<d2l-menu-item-filter
												value="[[item.properties.id]]"
												text="[[item.properties.name]]"
												selected="[[item.properties.selected]]">
											</d2l-menu-item-filter>
										</template>
									</d2l-menu>
								</div>
								<iron-scroll-threshold
									id="scrollThreshold"
									on-lower-threshold="_loadMore">
								</iron-scroll-threshold>
							</d2l-dropdown-content>
						</d2l-dropdown>
					</div>

					<div id="sortSection">
						<span id="sortText" class="dropdown-text" on-tap="_toggleSortDropdown">{{localize('sorting.sortDatePinned')}}</span>
						<d2l-dropdown id="sortDropdown">
							<button
								class="d2l-dropdown-opener dropdown-button"
								on-focus="_focusSortText"
								on-blur="_blurSortText">
								<d2l-icon icon="d2l-tier1:chevron-down" aria-hidden="true"></d2l-icon>
							</button>
							<d2l-dropdown-menu no-padding min-width="350">
								<d2l-menu label="{{localize('sorting.sortBy')}}">
									<div class="dropdown-content-header">
										<span class="dropdown-content-header-text">{{localize('sorting.sortBy')}}</span>
									</div>
									<d2l-menu-item-sort class="dropdown-content-gradient" value="courseCode" text="{{localize('sorting.courseCode')}}"></d2l-menu-item-sort>
									<d2l-menu-item-sort value="courseName" text="{{localize('sorting.courseName')}}"></d2l-menu-item-sort>
									<d2l-menu-item-sort value="pinDate" text="{{localize('sorting.datePinned')}}" selected></d2l-menu-item-sort>
									<d2l-menu-item-sort value="lastAccessed" text="{{localize('sorting.lastAccessed')}}"></d2l-menu-item-sort>
								</d2l-menu>
							</d2l-dropdown-menu>
						</d2l-dropdown>
					</div>
				</div>
			</div>
		</div>

		<h2 class="d2l-heading-3">{{localize('pinnedCourses')}}</h2>

		<template is="dom-if" if="[[!_hasPinnedEnrollments]]">
			<d2l-alert visible="[[!_hasPinnedEnrollments]]">
				{{localize('noPinnedCoursesMessage')}}
			</d2l-alert>
		</template>

		<d2l-course-tile-grid
			enrollments="{{pinnedEnrollments}}"
			enrollments-queue="{{pinnedEnrollmentsQueue}}"
			delay-course-tile-load="[[delayCourseTileLoad]]">
		</d2l-course-tile-grid>

		<h2 class="d2l-heading-3">{{localize('unpinnedCourses')}}</h2>

		<d2l-course-tile-grid
			enrollments="{{unpinnedEnrollments}}"
			enrollments-queue="{{unpinnedEnrollmentsQueue}}"
			delay-course-tile-load="[[delayCourseTileLoad]]">
		</d2l-course-tile-grid>
	</template>

	<script>
		'use strict';

		Polymer({
			is: 'd2l-all-courses',
			properties: {
				/*
				* Sets the delay-load property on the course tile grid
				* @type {Boolean}
				*/
				delayCourseTileLoad: {
					type: Boolean,
					value: true
				},
				/*
				* URL for search widget; should have search-my-enrollments Action
				*/
				searchUrl: {
					type: String,
					value: ''
				},
				_departmentOrganizations: {
					type: Array,
					value: function() {
						return [];
					}
				},
				_isFiltered: {
					type: Boolean,
					value: false
				},
				_hasMoreDepartments: {
					type: Boolean,
					value: false
				},
				_hasMoreSemesters: {
					type: Boolean,
					value: false
				},
				_moreDepartmentsUrl: {
					type: String,
					value: ''
				},
				_moreSemestersUrl: {
					type: String,
					value: ''
				},
				_searchSemestersAction: {
					type: Object,
					value: {
						'name':'search-course-collection',
						'method':'GET',
						'href':'/d2l/api/hm/organizations',
						'fields':[
							{'name':'search', 'type':'search', 'value':''},
							{'name':'page', 'type':'number', 'value':'1'},
							{'name':'pageSize', 'type':'number', 'value':'20'},
							{'name':'embedDepth', 'type':'number', 'value':'1'},
							{'name':'organizationTypeIds', 'type':'hidden', 'value':'5'}]
					}
				},
				_searchDepartmentsAction: {
					type: Object,
					value: {
						'name':'search-course-collection',
						'method':'GET',
						'href':'/d2l/api/hm/organizations',
						'fields':[
							{'name':'search', 'type':'search', 'value':''},
							{'name':'page', 'type':'number', 'value':'1'},
							{'name':'pageSize', 'type':'number', 'value':'20'},
							{'name':'embedDepth', 'type':'number', 'value':'1'},
							{'name':'organizationTypeIds', 'type':'hidden', 'value':'203'}]
					}
				},
				_semesterOrganizations: {
					type: Array,
					value: function() {
						return [];
					}
				},
				_sortField: String,
				_parentOrganizationIds: {
					type: Array,
					value: function() {
						return [];
					}
				}
			},
			behaviors: [
				Polymer.D2L.MyCourses.CourseTileResponsiveGridBehavior,
				Polymer.D2L.MyCourses.LocalizeBehavior,
				Polymer.D2L.MyCourses.CourseManagementBehavior
			],
			ready: function() {
				this.usePendingLists = true;

				// Both course tile grids in this view should have the same number of columns, so use a custom getter
				var courseTileGrids = Polymer.dom(this.root).querySelectorAll('d2l-course-tile-grid');
				for (var i = 0; i < courseTileGrids.length; i++) {
					courseTileGrids[i].getCourseTileItemCount = this.getCourseTileItemCount.bind(this);
				}

				this._selectSemesterList();
			},
			attached: function() {
				this._onResize();
				window.addEventListener('resize', this._onResize.bind(this));

				this.listen(this.$.sortDropdown, 'menu-item-selected', '_updateSortBy');
				this.listen(this.$.filterDropdown, 'menu-item-selected', '_updateFilter');

				this.listen(this.$.semesterSearchWidget, 'search-results-changed', '_onSemesterSearchResults');
				this.listen(this.$.departmentSearchWidget, 'search-results-changed', '_onDepartmentSearchResults');
				this.$.semesterSearchWidget.search();
				this.$.departmentSearchWidget.search();

				this.$.scrollThreshold.scrollTarget = this.$.filterDropdownContent.querySelector('.d2l-dropdown-content-container');
			},
			detached: function() {
				window.removeEventListener('resize', this._onResize.bind(this));

				this.unlisten(this.$.sortDropdown, 'menu-item-selected', '_updateSortBy');
				this.unlisten(this.$.filterDropdown, 'menu-item-selected', '_updateFilter');

				this.unlisten(this.$.semesterSearchWidget, 'search-results-changed', '_onSemesterSearchResults');
				this.unlisten(this.$.departmentSearchWidget, 'search-results-changed', '_onDepartmentSearchResults');
			},
			/*
			* Fetches set of focusable elements (all `<d2l-course-tile>`s)
			*
			* Required for accessibility, this specifies which elements within the element are intended to be
			* keyboard-focusable. This is because we're using `<iron-overlay with-backdrop>`. See
			* [those docs](https://github.com/PolymerElements/iron-overlay-behavior#backdrop) for more information.
			*
			* @return {Array<HTMLElement>} `<d2l-course-tile` HTMLElements
			*/
			focusableNodesOverride: function() {
				var courseTileFocusables = [];

				Polymer.dom(this.root).querySelectorAll('d2l-course-tile').forEach(function(courseTile) {
					Array.prototype.push.apply(courseTileFocusables, Polymer.dom(courseTile.root).querySelectorAll('a'));
				});

				return courseTileFocusables;
			},
			/*
			* Fetches the max value between the pinned and unpinned enrollments
			* @return {Number} Max(number of pinned enrollments, number of unpinned enrollments)
			*/
			getCourseTileItemCount: function() {
				var itemCount = Math.max(this.pinnedEnrollments.length, this.unpinnedEnrollments.length);

				return itemCount;
			},
			loadCourseTiles: function() {
				this.delayCourseTileLoad = false;
			},
			_numSemesterFilters: 0,
			_numDepartmentFilters: 0,
			_sortTextOptions: {
				'courseCode': 'sorting.sortCourseCode',
				'courseName': 'sorting.sortCourseName',
				'pinDate': 'sorting.sortDatePinned',
				'lastAccessed': 'sorting.sortLastAccessed'
			},
			_checkFilterEntities: function(entities) {
				entities.forEach(function(entity) {
					entity.properties.selected = this._parentOrganizationIds.indexOf(entity.properties.id.toString()) > -1;
				}.bind(this));
			},
			_clearFilters: function() {
				Polymer.dom(this.$.filterDropdown).querySelectorAll('d2l-menu-item-filter').forEach(function(item) {
					item.selected = false;
				});
				this._isFiltered = false;
				// Clear button is removed via dom-if, so need to manually set focus to next element
				this.$.semesterListButton.focus();
				this._parentOrganizationIds = [];
				this.$.filterText.textContent = this.localize('filtering.filter');
				this.$.semesterListButton.textContent = this.localize('filtering.semester');
				this.$.departmentListButton.textContent = this.localize('filtering.department');
				this._numSemesterFilters = 0;
				this._numDepartmentFilters = 0;
			},
			_loadMore: function() {
				// Generate the request based off of which tab is selected, and whether there are more to load or not
				if (this.$.semesterList.classList.contains('hidden')) {
					if (this._hasMoreDepartments) {
						this.$.moreDepartmentsRequest.generateRequest();
					}
				} else {
					if (this._hasMoreSemesters) {
						this.$.moreSemesters.generateRequest();
					}
				}
				this.$.scrollThreshold.clearTriggers();
			},
			_blurFilterText: function() {
				this.toggleClass('focus', false, this.$.filterText);
			},
			_blurSortText: function() {
				this.toggleClass('focus', false, this.$.sortText);
			},
			_focusFilterText: function() {
				this.toggleClass('focus', true, this.$.filterText);
			},
			_focusSortText: function() {
				this.toggleClass('focus', true, this.$.sortText);
			},
			_updateMoreParameters: function(entity, moreUrlPath, hasMorePath) {
				this._checkFilterEntities(entity.entities);

				this.set(hasMorePath, entity.hasLinkByRel('next'));
				this.set(moreUrlPath, this[hasMorePath] ? entity.getLinkByRel('next').href : '');
			},
			_onDepartmentSearchResults: function(e) {
				this.set('_departmentOrganizations', e.detail.value.entities);
				this._updateMoreParameters(e.detail.value, '_moreDepartmentsUrl', '_hasMoreDepartments');
				this.$.departmentList.querySelector('d2l-menu').resize();
			},
			_onSemesterSearchResults: function(e) {
				this.set('_semesterOrganizations', e.detail.value.entities);
				this._updateMoreParameters(e.detail.value, '_moreSemestersUrl', '_hasMoreSemesters');
				this.$.semesterList.querySelector('d2l-menu').resize();
			},
			_onMoreResponse: function(response, organizationsPath, moreUrlPath, hasMorePath) {
				if (response.detail.status === 200 || response.detail.status === 304) {
					var parser = document.createElement('d2l-siren-parser');
					var responseEntity = parser.parse(response.detail.xhr.response);

					responseEntity.entities.forEach(function(entity) {
						this.push(organizationsPath, entity);
					}.bind(this));

					this._updateMoreParameters(responseEntity, moreUrlPath, hasMorePath);
				}
			},
			_onMoreDepartmentsResponse: function(response) {
				this._onMoreResponse(response, '_departmentOrganizations', '_moreDepartmentsUrl', '_hasMoreDepartments');
			},
			_onMoreSemestersResponse: function(response) {
				this._onMoreResponse(response, '_semesterOrganizations', '_moreSemestersUrl', '_hasMoreSemesters');
			},
			_onResize: function() {
				this.toggleClass('hidden', window.innerWidth < 768, this.$.filterSection);
				this.toggleClass('hidden', window.innerWidth < 768, this.$.sortSection);
			},
			_selectSemesterList: function() {
				this._toggleSelectedList(this.$.semesterList, this.$.semesterListButton, this.$.semesterListHighlight, true);
				this._toggleSelectedList(this.$.departmentList, this.$.departmentListButton, this.$.departmentListHighlight, false);
				this.$.semesterSearchWidget.clear();
				this.$.departmentSearchWidget.clear();
				this.$.semesterList.querySelector('d2l-menu').resize();
			},
			_selectDepartmentList: function() {
				this._toggleSelectedList(this.$.departmentList, this.$.departmentListButton, this.$.departmentListHighlight, true);
				this._toggleSelectedList(this.$.semesterList, this.$.semesterListButton, this.$.semesterListHighlight, false);
				this.$.semesterSearchWidget.clear();
				this.$.departmentSearchWidget.clear();
				this.$.departmentList.querySelector('d2l-menu').resize();
			},
			_toggleSelectedList: function(list, button, highlight, selected) {
				this.toggleClass('hidden', !selected, list);
				this.toggleClass('selected', selected, button);
				this.toggleClass('invisible', !selected, highlight);
				button.setAttribute('aria-pressed', selected);
			},
			_toggleFilterDropdown: function() {
				this.$.filterDropdown.toggleOpen();
				this.$.departmentList.querySelector('d2l-menu').resize();
				this.$.semesterList.querySelector('d2l-menu').resize();
			},
			_toggleSortDropdown: function() {
				this.$.sortDropdown.toggleOpen();
			},
			_updateFilter: function(e) {
				var isSemester = this.$.semesterList.contains(e.target);

				if (e.detail.selected) {
					this.push('_parentOrganizationIds', e.detail.value);
					isSemester ? this._numSemesterFilters++ : this._numDepartmentFilters++;
				} else {
					var index = this._parentOrganizationIds.indexOf(e.detail.value);
					this.splice('_parentOrganizationIds', index, 1);
					isSemester ? this._numSemesterFilters-- : this._numDepartmentFilters--;
				}

				if (this._parentOrganizationIds.length === 0) {
					this.$.filterText.textContent = this.localize('filtering.filter');
				} else if (this._parentOrganizationIds.length === 1) {
					this.$.filterText.textContent = this.localize('filtering.filterSingle');
				} else {
					this.$.filterText.textContent = this.localize('filtering.filterMultiple', 'num', this._parentOrganizationIds.length);
				}

				this._isFiltered = this._parentOrganizationIds.length > 0;
				this.$.semesterListButton.textContent = this._numSemesterFilters > 0
					? this.localize('filtering.semesterMultiple', 'num', this._numSemesterFilters)
					: this.localize('filtering.semester');
				this.$.departmentListButton.textContent = this._numDepartmentFilters > 0
					? this.localize('filtering.departmentMultiple', 'num', this._numDepartmentFilters)
					: this.localize('filtering.department');
			},
			_updateSortBy: function(e) {
				this.set('_sortField', e.detail.value);

				var menuItems = Polymer.dom(this.$.sortDropdown).querySelectorAll('d2l-menu-item-sort');
				menuItems.forEach(function(item) {
					if (item.value !== this._sortField) {
						item.selected = false;
					}
				}.bind(this));

				this.$.sortText.textContent = this.localize(this._sortTextOptions[this._sortField] || '');
			}
		});
	</script>
</dom-module>
